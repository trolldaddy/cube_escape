<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é­”æ–¹æ–°ä¸–ç•Œ - æ•´åˆçµ‚ç«¯ V8</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto+Sans+TC', sans-serif; background-color: #020617; color: #e2e8f0; touch-action: manipulation; overflow: hidden; }

        /* ä½ˆå±€ï¼šå›ºå®šä¸­å¤®åœ°åœ– + ä¸‰æŠ½å±œï¼ˆå³å´å–ä»£åŸæœ¬çš„ä¸‹æ–¹ï¼‰ */
        .main-stage { position: relative; min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .map-shell { background-color: #0f172a; border-radius: 1.5rem; border: 2px solid #1e293b; padding: 16px; box-shadow: 0 20px 80px rgba(0,0,0,0.45); }
        .drawer { position: fixed; background: rgba(15, 23, 42, 0.96); border: 1px solid #1e293b; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.4); transition: transform 0.28s ease, opacity 0.28s ease; z-index: 60; }
        .drawer-top { top: 12px; left: 50%; transform: translate(-50%, -102%); width: min(1100px, 96%); padding: 18px; }
        .drawer-top.open { transform: translate(-50%, 0); }
        .drawer-left { left: 12px; top: 50%; transform: translate(-102%, -50%); width: 320px; padding: 18px; max-height: calc(100vh - 80px); overflow-y: auto; }
        .drawer-left.open { transform: translate(0, -50%); }
        .drawer-right { right: 12px; top: 50%; transform: translate(102%, -50%); width: 420px; padding: 18px; max-height: calc(100vh - 80px); overflow: hidden; display: flex; flex-direction: column; }
        .drawer-right.open { transform: translate(0, -50%); }
        .drawer-right.peek { transform: translate(calc(100% - 240px), -50%); max-height: 360px; }
        .drawer-handle { position: fixed; z-index: 70; background: #1d4ed8; color: white; border-radius: 9999px; padding: 10px 14px; font-weight: 900; font-size: 12px; letter-spacing: 0.5px; box-shadow: 0 10px 30px rgba(37,99,235,0.5); }
        .drawer-handle:hover { background: #2563eb; }
        .handle-top { top: 12px; left: 50%; transform: translateX(-50%); }
        .handle-left { left: 12px; top: 50%; transform: translate(-10%, -50%) rotate(-90deg); transform-origin: left center; }
        .handle-right { right: 12px; top: 50%; transform: translate(10%, -50%) rotate(90deg); transform-origin: right center; }

        /* åœ°åœ–ç›¸é—œæ¨£å¼ */
        #mapContainer { position: relative; width: fit-content; margin: 0 auto; background-color: #0f172a; border-radius: 1.25rem; border: 2px solid #1e293b; overflow: hidden; }
        #bgMapImage { display: block; max-width: 100%; height: auto; z-index: 5; }
        #interactionOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; }
        .room-zone { position: absolute; cursor: pointer; border: 1px solid transparent; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .room-target { background-color: rgba(59, 130, 246, 0.2) !important; border: 2px solid #3b82f6 !important; }
        .room-bombed { background-color: rgba(239, 68, 68, 0.3) !important; border: 2px solid #ef4444 !important; animation: bomb-pulse 1s infinite; }
        @keyframes bomb-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .room-zone:active { scale: 0.98; }

        /* æŠ½å±œå…§å®¹ */
        .drawer-title { font-size: 14px; font-weight: 900; letter-spacing: 1px; color: #cbd5e1; text-transform: uppercase; }
        .drawer-sub { font-size: 12px; color: #64748b; }

        /* HP ç¶²æ ¼ */
        .hp-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 2px; width: 100%; height: 8px; }
        .hp-bar-segment { height: 100%; border-radius: 1px; background-color: #1e293b; }
        .hp-active { background-color: #22c55e; }
        .hp-danger { background-color: #ef4444; }
        .hp-will-lose { background-color: #f59e0b; opacity: 0.3; animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { opacity: 0.2; } 50% { opacity: 0.6; } }

        /* é“å…·æ ¼èˆ‡å…©è¡Œé«˜æŒ‰éˆ• */
        .cell-item { 
            display: flex; align-items: center; justify-content: space-between; 
            border-radius: 12px; border: 2px solid transparent; 
            cursor: pointer; transition: all 0.2s; min-height: 70px; overflow: hidden;
        }
        .cell-on { background-color: #2563eb; color: #fff; border-color: #60a5fa; }
        .cell-off { background-color: #1e293b; color: #64748b; border-color: #0f172a; }
        
        .tall-btn { 
            width: 32px; align-self: stretch; display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.2); font-weight: 900; font-size: 16px; transition: background 0.2s;
        }
        .tall-btn:active { background: rgba(255,255,255,0.2); }
        
        .item-label-container { flex: 1; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 4px; }
        .cell-label { font-size: 11px; font-weight: 800; line-height: 1.2; }
        
        /* æ•¸å€¼æ¨™ç±¤èˆ‡ä½ç½®æ¨™ç±¤ */
        .gun-tag { font-size: 9px; background: #ef4444; color: white; padding: 1px 3px; border-radius: 4px; margin-left: 2px; font-weight: 900; }
        .room-badge { background: #0f172a; color: #3b82f6; padding: 2px 8px; border-radius: 6px; font-size: 14px; font-weight: 900; border: 1px solid #1e293b; }
        .occupant-stack { display: flex; flex-direction: column; gap: 2px; align-items: center; pointer-events: none; }
        .occupant-tag { background-color: #ef4444; color: white; font-size: 10px; font-weight: 900; padding: 2px 6px; border-radius: 4px; pointer-events: none; border: 1px solid white; z-index: 50; white-space: nowrap; }
        
        /* ç½®ä¸­é“å…·æ ¼æ¨£å¼ (å³å´å…­æ ¼) */
        .center-item { justify-content: center; text-align: center; flex-direction: column; padding: 8px; }
        .action-btn { background-color: #facc15; color: #000; font-size: 10px; font-weight: 900; padding: 4px 8px; border-radius: 6px; margin-top: 4px; transition: all 0.2s; }
        .action-btn-used { background-color: #475569; color: #cbd5e1; }
        .player-card-active { ring: 2px solid #3b82f6; background-color: #0f172a !important; border-color: #3b82f6 !important; }
        .drawer-right.peek .player-details { display: none; }
        .drawer-right.peek #playerList { max-height: 280px !important; }
        .drawer-right.peek .player-card-shell { padding-right: 10px; }

        /* å¹³æ¿è£ç½®é©é… */
        body { -webkit-tap-highlight-color: transparent; }
        button, input, select { min-height: 44px; }
        .tap-friendly { min-height: 44px; min-width: 44px; }
        @media (max-width: 1100px) {
            .map-shell { width: 100%; max-width: 100%; padding: 12px; }
            #mapContainer { width: 100%; max-width: 100%; }
            #interactionOverlay { touch-action: manipulation; }
            .min-h-[500px] { min-height: 400px; }
            .tall-btn { font-size: 18px; }
            .drawer-right { width: 360px; }
        }
        @media (max-width: 900px) {
            body { padding: 0; }
            .main-stage { padding: 12px; }
            #mapContainer { border-radius: 1rem; }
            .room-zone { border-radius: 12px; }
            .action-btn { width: 100%; }
            .drawer-left { width: 280px; }
            .drawer-right { width: min(92vw, 360px); max-height: 65vh; }
            .min-h-[500px] { min-height: 320px; }
        }
    </style>
</head>
<body>
    <div class="main-stage">
        <div class="absolute top-4 left-1/2 -translate-x-1/2 flex items-center gap-3">
            <h1 class="text-2xl font-black text-white tracking-tight">CUBE ESCAPE <span class="text-blue-500 font-light italic text-lg">v8</span></h1>
        </div>

        <div class="map-shell">
            <div id="mapStatusTip" class="bg-red-600/20 text-red-500 text-[10px] font-black py-2 px-4 rounded-xl text-center uppercase tracking-widest hidden border border-red-600/30 mb-3">âš ï¸ è«‹åœ¨åœ°åœ–ä¸Šé»é¸è½Ÿç‚¸ç›®æ¨™æˆ¿é–“ âš ï¸</div>
            <div class="bg-slate-900/60 rounded-[1.75rem] border border-slate-800/50 p-3 flex items-center justify-center min-h-[500px] relative overflow-hidden">
                <div id="mapContainer">
                    <img id="bgMapImage" src="https://raw.githubusercontent.com/trolldaddy/cube_escape/b03b1311f1a19acb5841f42579a0e78f2033ce48/p650925325.jpg" alt="åœ°åœ–" onload="renderZones()">
                    <div id="interactionOverlay"></div>
                </div>
            </div>
        </div>

        <!-- æŠ½å±œé–‹é—œ -->
        <button class="drawer-handle handle-top" onclick="toggleDrawer('top')">çµ±è¨ˆè¡¨æ ¼</button>
        <button class="drawer-handle handle-left" onclick="toggleDrawer('left')">é€šç”¨æ“ä½œ</button>
        <button class="drawer-handle handle-right" onclick="toggleDrawer('right')">ç©å®¶é¢æ¿</button>

        <!-- ä¸ŠæŠ½å±œï¼šçµ±è¨ˆè¡¨ -->
        <div id="topDrawer" class="drawer drawer-top">
            <div class="flex items-center justify-between mb-3">
                <div>
                    <div class="drawer-title">å—è©¦è€…çµ±è¨ˆ</div>
                    <div class="drawer-sub">å¿«æ·æŸ¥çœ‹æ‰€æœ‰ç©å®¶ç•¶å‰ä½ç½®èˆ‡å±¬æ€§</div>
                </div>
                <button onclick="toggleDrawer('top')" class="text-slate-400 hover:text-white font-black">æ”¶åˆ</button>
            </div>
            <div class="bg-slate-900/80 rounded-2xl border border-slate-800 overflow-hidden">
                <table class="w-full text-left text-[11px]">
                    <thead class="bg-slate-800/50 text-slate-500 font-black uppercase">
                        <tr><th class="p-3">å—è©¦è€…</th><th class="p-3">ä½ç½®</th><th class="p-3">åŠ›(ç¸½)/é€Ÿ/è² </th><th class="p-3 text-right">é æœŸ HP</th></tr>
                    </thead>
                    <tbody id="summaryTableBody" class="divide-y divide-slate-800/50"></tbody>
                </table>
            </div>
        </div>

        <!-- å·¦æŠ½å±œï¼šé€šç”¨æ“ä½œ -->
        <div id="leftDrawer" class="drawer drawer-left">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <div class="drawer-title">é€šç”¨æ“ä½œ</div>
                    <div class="drawer-sub">æ–°å¢ç©å®¶ã€å›åˆé¸æ“‡èˆ‡çµç®—</div>
                </div>
                <button onclick="toggleDrawer('left')" class="text-slate-400 hover:text-white font-black">æ”¶åˆ</button>
            </div>
            <div class="space-y-3">
                <label class="text-xs text-slate-400 font-bold">éŠæˆ²å›åˆ</label>
                <select id="gameRound" onchange="renderAll()" class="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-3 font-black text-amber-500 outline-none">
                    <option value="1">å›åˆ 1 (æ¯’-1)</option><option value="2">å›åˆ 2 (æ¯’-2)</option>
                    <option value="3">å›åˆ 3 (æ¯’-2)</option><option value="4">å›åˆ 4 (æ¯’-3)</option>
                    <option value="5">å›åˆ 5 (æ¯’-3)</option><option value="6">å›åˆ 6 (æ¯’-4)</option>
                </select>

                <label class="text-xs text-slate-400 font-bold">å¿«é€Ÿåˆ‡æ›ç•¶å‰æ“ä½œç©å®¶</label>
                <select id="activePlayerSelect" onchange="selectPlayerFromDropdown(this.value)" class="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-3 font-black text-blue-200 outline-none"></select>

                <div class="flex gap-2">
                    <input type="text" id="playerNameInput" placeholder="è¼¸å…¥ç©å®¶åç¨±..." class="bg-slate-950 border border-slate-800 rounded-xl px-4 py-3 w-full font-bold outline-none" onkeypress="if(event.key==='Enter') addPlayer()">
                    <button onclick="addPlayer()" class="bg-blue-600 w-12 rounded-xl font-black text-white text-xl">ï¼‹</button>
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <button onclick="processTurn()" class="bg-emerald-600 py-3 rounded-xl font-black text-white text-sm uppercase">å›åˆçµç®—</button>
                    <button onclick="resetData()" class="bg-slate-800 py-3 rounded-xl text-slate-400 font-bold text-xs">æ¸…ç©ºæ•¸æ“š</button>
                </div>
            </div>
        </div>

        <!-- å³æŠ½å±œï¼šç©å®¶æ§åˆ¶ -->
        <div id="rightDrawer" class="drawer drawer-right">
            <div class="flex items-center justify-between mb-3">
                <div>
                    <div class="drawer-title">ç©å®¶æ“ä½œé¢æ¿</div>
                    <div class="drawer-sub">èª¿æ•´å±¬æ€§ã€é“å…·èˆ‡ä½ç½®ï¼Œè¼”åŠ©å°ç…§ä¸­å¤®åœ°åœ–</div>
                </div>
                <button onclick="toggleDrawer('right')" class="text-slate-400 hover:text-white font-black">æ”¶åˆ</button>
            </div>
            <div id="playerList" class="space-y-4 overflow-y-auto pr-2" style="max-height: calc(60vh - 64px);"></div>
        </div>
    </div>

    <!-- çµç®—å½ˆçª— -->
    <div id="resultModal" class="fixed inset-0 bg-black/90 z-[100] hidden flex items-center justify-center p-6">
        <div class="bg-slate-900 border border-slate-700 rounded-[2rem] max-w-md w-full p-6 space-y-4">
            <h3 class="text-xl font-black text-white">å›åˆçµç®—å ±å‘Š</h3>
            <div id="resultContent" class="space-y-2 text-sm text-slate-400"></div>
            <div class="flex justify-end gap-2 pt-4">
                <button onclick="document.getElementById('resultModal').classList.add('hidden')" class="px-4 py-2 text-slate-500 font-bold">å–æ¶ˆ</button>
                <button onclick="confirmSettle()" class="px-6 py-2 bg-blue-600 rounded-xl font-black text-white">ç¢ºèªæ›´æ–°</button>
            </div>
        </div>
    </div>

    <script>
        let players = [];
        let selectedUid = null;
        let isAimingMode = false;
        let isMoveMode = false;
        const drawerState = { top: true, left: true, right: true };
        const STORAGE_KEY = 'cube_escape_v8_refined';
        const mapConfig = [{"id":"201","name":"åŸºå› åº«","x":27.65,"y":8.31,"w":18.41,"h":10.51},{"id":"202","name":"åœæ©Ÿåª","x":67.44,"y":9.76,"w":23.60,"h":8.56},{"id":"101","name":"æ°´å¡”","x":16.44,"y":18.17,"w":6.03,"h":9.91},{"id":"102","name":"æ¿€å…‰å®¤","x":27.87,"y":18.72,"w":18.20,"h":8.86},{"id":"103","name":"*","x":68.92,"y":18.72,"w":6.88,"h":8.71},{"id":"104","name":"#","x":76.54,"y":18.57,"w":14.39,"h":9.01},{"id":"B101","name":"æ§åˆ¶å®¤","x":9.24,"y":28.18,"w":6.88,"h":9.16},{"id":"B102","name":"#","x":16.54,"y":28.48,"w":5.61,"h":9.01},{"id":"B103","name":"*","x":22.89,"y":28.33,"w":4.44,"h":9.16},{"id":"B104","name":"#","x":27.87,"y":28.48,"w":18.10,"h":9.01},{"id":"B105","name":"å›æ”¶ç«™","x":46.70,"y":28.63,"w":10.58,"h":8.71},{"id":"B106","name":"#","x":72.52,"y":28.63,"w":7.20,"h":9.01},{"id":"B107","name":"æ­¦å™¨åº«","x":80.14,"y":28.43,"w":10.58,"h":9.01},{"id":"B201","name":"#","x":9.14,"y":38.34,"w":10.58,"h":9.01},{"id":"B202","name":"æ‰‹è¡“å®¤","x":20.35,"y":38.49,"w":7.09,"h":8.56},{"id":"B203","name":"#","x":27.87,"y":38.24,"w":10.69,"h":8.86},{"id":"B204","name":"é¤å»³","x":38.87,"y":38.24,"w":7.20,"h":9.16},{"id":"B205","name":"#","x":46.70,"y":38.24,"w":6.67,"h":9.16},{"id":"B206","name":"é‡‘åº«","x":68.92,"y":38.19,"w":21.80,"h":9.31},{"id":"B301","name":"è—¥æˆ¿","x":9.14,"y":48.10,"w":6.77,"h":8.71},{"id":"B302","name":"#","x":16.65,"y":47.95,"w":6.88,"h":9.16},{"id":"B303","name":"*","x":24.06,"y":48.10,"w":6.88,"h":9.01},{"id":"B304","name":"æ“ä½œå®¤","x":31.46,"y":48.10,"w":7.20,"h":8.86},{"id":"B305","name":"#","x":39.08,"y":47.95,"w":14.39,"h":9.01},{"id":"B306","name":"#","x":68.92,"y":47.95,"w":4.44,"h":9.01},{"id":"B307","name":"*","x":73.90,"y":47.80,"w":9.63,"h":9.61},{"id":"B308","name":"#","x":83.84,"y":47.95,"w":7.20,"h":9.16},{"id":"B401","name":"#","x":31.57,"y":57.86,"w":14.39,"h":9.01},{"id":"B402","name":"*","x":46.60,"y":57.71,"w":6.67,"h":9.31},{"id":"B403","name":"å‚³é€å®¤","x":68.92,"y":57.71,"w":6.88,"h":9.16},{"id":"B404","name":"#","x":76.44,"y":57.86,"w":6.88,"h":8.71},{"id":"B405","name":"#","x":83.74,"y":57.86,"w":6.98,"h":9.01},{"id":"B501","name":"å¤§å€‰åº«","x":9.14,"y":57.86,"w":21.69,"h":18.62},{"id":"B502","name":"#","x":31.57,"y":67.62,"w":10.58,"h":8.86},{"id":"B503","name":"åƒåœ¾å ´","x":42.79,"y":67.77,"w":14.39,"h":9.01},{"id":"B504","name":"#","x":68.92,"y":67.77,"w":10.58,"h":9.01},{"id":"B505","name":"ç³§å€‰","x":80.14,"y":67.62,"w":10.79,"h":9.16},{"id":"B601","name":"é…’çª–","x":27.87,"y":77.23,"w":17.99,"h":9.31},{"id":"B602","name":"#","x":46.49,"y":77.38,"w":10.69,"h":9.01},{"id":"B603","name":"*","x":57.71,"y":77.38,"w":10.58,"h":9.01},{"id":"B604","name":"#","x":68.92,"y":77.38,"w":10.69,"h":9.01},{"id":"B701","name":"åœå±é–“","x":46.81,"y":87.29,"w":10.26,"h":9.01}];
        
        window.onload = () => { const saved = localStorage.getItem(STORAGE_KEY); if (saved) players = JSON.parse(saved); renderAll(); };
        function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(players)); }

        function toggleDrawer(key) { drawerState[key] = !drawerState[key]; applyDrawerState(); }
        function setRightOpen(val) { drawerState.right = val; applyDrawerState(); }
        function applyDrawerState() {
            ['top','left','right'].forEach(key => {
                const el = document.getElementById(`${key}Drawer`);
                if (!el) return;
                el.classList.toggle('open', drawerState[key]);
                if (key === 'right') {
                    el.classList.toggle('peek', !drawerState[key]);
                }
            });
        }
        
        function getCalculatedState() {
            const round = parseInt(document.getElementById('gameRound').value); 
            const gasDmgList = [0, 1, 2, 2, 3, 3, 4]; 
            const gasDmg = gasDmgList[round];

            return players.map(p => {
                let dmg = 0; let weightUsed = 0;
                // å°åˆ€æ”¹ç‚º +2
                let weaponStrBonus = (p.weapons.shotgun * 4) + (p.weapons.pistol * 2) + (p.weapons.knife * 2);
                
                weightUsed += (p.items.mask?1:0) + (p.items.rope?1:0) + (p.items.adrenaline?1:0) + (p.items.recycler?1:0) + (p.items.rocketLauncher?1:0);
                weightUsed += (p.weapons.shotgun || 0) + (p.weapons.pistol || 0) + (p.weapons.knife || 0);

                if (!p.items.mask && p.gasStatus && !p.isShadow) dmg += gasDmg;
                players.forEach(other => { if (other.items.rocketLauncher && other.rocketTarget && p.currentRoomId?.toUpperCase() === other.rocketTarget.toUpperCase()) dmg += 4; });
                
                const finalSpdText = p.items.adrenaline ? `${p.spd} (10)` : p.spd;
                const totalStr = p.str + weaponStrBonus;
                const hasGun = (p.weapons.shotgun > 0) || (p.weapons.pistol > 0);

                return { ...p, totalStr, expectedDmg: dmg, newHp: Math.max(0, p.hp - dmg), finalSpdText, weightUsed, overweight: !p.items.dimensionPocket && weightUsed > p.lod, hasGun };
            });
        }

        function addPlayer() {
            const name = document.getElementById('playerNameInput').value.trim();
            if (!name) return;
            const uid = Date.now();
            players.push({ uid, name, hp: 10, currentRoomId: null, gasStatus: false, isShadow: false, str: 4, spd: 3, lod: 3, rocketTarget: '', recyclerUsed: false, weapons: { shotgun: 0, pistol: 0, knife: 0 }, items: { mask: false, rope: false, adrenaline: false, recycler: false, rocketLauncher: false, dimensionPocket: false } });
            selectedUid = uid;
            isMoveMode = false;
            isAimingMode = false;
            document.getElementById('playerNameInput').value = '';
            renderAll(); save();
        }

        function selectPlayerFromDropdown(val) {
            selectedUid = val ? parseInt(val) : null;
            isAimingMode = false;
            isMoveMode = false;
            renderAll();
        }

        function startMoveMode(uid) {
            selectedUid = uid;
            isAimingMode = false;
            isMoveMode = true;
            renderAll();
            setRightOpen(false);
        }

        function startAimingMode(uid) {
            selectedUid = uid;
            isMoveMode = false;
            isAimingMode = true;
            renderAll();
            setRightOpen(false);
        }
        
        function toggleItem(uid, key) { 
            const p = players.find(x => x.uid === uid); 
            if (p) { p.items[key] = !p.items[key]; if (key === 'rocketLauncher' && !p.items[key]) { p.rocketTarget = ''; } renderAll(); save(); } 
        }

        function toggleRecyclerUse(uid) {
            const p = players.find(x => x.uid === uid);
            if (p) { p.recyclerUsed = !p.recyclerUsed; renderAll(); save(); }
        }

        function changeWeapon(uid, key, delta) {
            const p = players.find(x => x.uid === uid);
            if (p) { p.weapons[key] = Math.max(0, p.weapons[key] + delta); renderAll(); save(); }
        }

        function changeAttr(uid, key, delta) { const p = players.find(x => x.uid === uid); if (p) { p[key] = Math.max(0, p[key] + delta); renderAll(); save(); } }
        function selectPlayer(uid) { selectedUid = uid; isAimingMode = false; isMoveMode = false; renderAll(); }
        
        function moveOrTarget(rid) {
            if (!selectedUid) return;
            const p = players.find(x => x.uid === selectedUid);
            if (isAimingMode) {
                p.rocketTarget = rid;
                isAimingMode = false;
            } else if (isMoveMode) {
                p.currentRoomId = rid;
                isMoveMode = false;
            } else {
                return;
            }
            setRightOpen(true);
            renderAll(); save();
        }

        function processTurn() { const data = getCalculatedState(); let html = ''; data.forEach(p => { if (p.expectedDmg > 0) html += `<div><b>${p.name}</b> å—å‚· ${p.expectedDmg} (HP: ${p.hp} -> ${p.newHp})</div>`; }); document.getElementById('resultContent').innerHTML = html || 'æœ¬å›åˆç„¡äººå—å‚·'; document.getElementById('resultModal').classList.remove('hidden'); }
        function confirmSettle() { const data = getCalculatedState(); players = data.map(p => ({ ...p, hp: p.newHp, gasStatus: false, rocketTarget: '', recyclerUsed: false, items: { ...p.items, adrenaline: false }})); document.getElementById('resultModal').classList.add('hidden'); renderAll(); save(); }
        
        function renderAll() {
            if (selectedUid && !players.some(p => p.uid === selectedUid)) selectedUid = players[0]?.uid || null;
            applyDrawerState();
            renderActiveSelect();
            renderPlayers();
            renderZones();
            renderSummary();
        }
        
        function renderPlayers() {
            const list = document.getElementById('playerList'); const data = getCalculatedState(); list.innerHTML = '';
            const visiblePlayers = selectedUid ? data.filter(p => p.uid === selectedUid) : data;

            if (!visiblePlayers.length) {
                list.innerHTML = '<div class="text-center text-slate-500 font-bold py-6">è«‹å…ˆæ–°å¢ä¸¦é¸æ“‡ç©å®¶</div>';
                return;
            }

            visiblePlayers.forEach(p => {
                const isActive = selectedUid === p.uid;
                const card = document.createElement('div');
                card.className = `player-card-shell bg-slate-900 border border-slate-800 rounded-[2.5rem] p-6 cursor-pointer transition-all ${isActive ? 'player-card-active shadow-2xl' : (p.isShadow ? 'opacity-40' : '')}`;
                card.onclick = (e) => { if(!e.target.closest('button') && !e.target.closest('input')) selectPlayer(p.uid); };
                
                let hpHtml = ''; for(let i=1; i<=10; i++) { hpHtml += `<div class="hp-bar-segment ${i <= p.newHp ? (p.newHp <= 3 ? 'hp-danger' : 'hp-active') : (i <= p.hp ? 'hp-will-lose' : '')}"></div>`; }
                
                const gridHtml = [
                    { type: 'weapon', k: 'shotgun', l: 'éœ°å½ˆæ§', e: 'ğŸ”«' },
                    { type: 'item', k: 'adrenaline', l: 'è…ä¸Šè…ºç´ ', e: 'ğŸ’‰' },
                    { type: 'item', k: 'rocketLauncher', l: 'ç«ç®­ç­’', e: 'ğŸš€', action: 'aim' },
                    { type: 'weapon', k: 'pistol', l: 'æ‰‹æ§', e: 'ğŸ”«' },
                    { type: 'item', k: 'rope', l: 'ç¹©ç´¢', e: 'ğŸª¢' },
                    { type: 'item', k: 'dimensionPocket', l: 'æ¬¡å…ƒå£è¢‹', e: 'ğŸŒ€' },
                    { type: 'weapon', k: 'knife', l: 'å°åˆ€', e: 'ğŸ”ª' },
                    { type: 'item', k: 'mask', l: 'é˜²æ¯’é¢å…·', e: 'ğŸ­' },
                    { type: 'item', k: 'recycler', l: 'å¾ªç’°å›æ”¶', e: 'â™»ï¸', action: 'use' }
                ].map((item, idx) => {
                    if (item.type === 'weapon') {
                        const count = p.weapons[item.k];
                        return `<div class="cell-item ${count > 0 ? 'cell-on' : 'cell-off'}">
                            <button onclick="event.stopPropagation(); changeWeapon(${p.uid}, '${item.k}', -1)" class="tall-btn">ï¼</button>
                            <div class="item-label-container">
                                <span class="cell-label">${item.e}<br>${item.l}</span>
                                <span class="text-xs font-black mt-1">${count}</span>
                            </div>
                            <button onclick="event.stopPropagation(); changeWeapon(${p.uid}, '${item.k}', 1)" class="tall-btn">ï¼‹</button>
                        </div>`;
                    } else {
                        const on = p.items[item.k];
                        let actionHtml = '';
                        if (on && item.action === 'aim') {
                            actionHtml = `<button onclick="event.stopPropagation(); startAimingMode(${p.uid}); renderAll();" class="action-btn">${p.rocketTarget || 'ç„æº–'}</button>`;
                        } else if (on && item.action === 'use') {
                            actionHtml = `<button onclick="event.stopPropagation(); toggleRecyclerUse(${p.uid})" class="action-btn ${p.recyclerUsed ? 'action-btn-used' : ''}">${p.recyclerUsed ? 'å·²ä½¿ç”¨' : 'ä½¿ç”¨'}</button>`;
                        }
                        return `<div onclick="event.stopPropagation(); toggleItem(${p.uid}, '${item.k}')" class="cell-item center-item ${on ? 'cell-on' : 'cell-off'}">
                            <span class="cell-label">${item.e} ${item.l}</span>
                            <div class="text-[9px] opacity-60">${on ? 'å·²æŒæœ‰' : 'æœªæŒæœ‰'}</div>
                            ${actionHtml}
                        </div>`;
                    }
                }).join('');

                card.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <div class="flex items-center gap-3">
                            <span class="text-xl font-black text-white">${p.name}</span>
                            <button onclick="event.stopPropagation(); startMoveMode(${p.uid});" class="px-3 py-1 rounded-lg text-xs font-black bg-slate-800 text-blue-200 hover:bg-slate-700">ç§»å‹•</button>
                            <span class="room-badge">${p.currentRoomId || '??'}</span>
                        </div>
                        <div class="flex items-center gap-2">
                             <span class="text-2xl font-black ${p.hp <= 3 ? 'text-red-500' : 'text-green-500'}">${p.hp}</span>
                        </div>
                    </div>
                    <div class="hp-grid mb-4">${hpHtml}</div>

                    <div class="grid grid-cols-3 gap-2 mb-4">
                        ${[{k:'str',l:'æ­¦åŠ›',v:p.totalStr,tag:p.hasGun?'(æŒæ§)':''},{k:'spd',l:'é€Ÿåº¦',v:p.finalSpdText},{k:'lod',l:'è² é‡',v:p.lod}].map(a => `
                            <div class="bg-slate-950/40 rounded-xl overflow-hidden flex justify-between items-center border border-slate-800">
                                <button onclick="event.stopPropagation(); changeAttr(${p.uid},'${a.k}',-1)" class="tall-btn">ï¼</button>
                                <div class="text-center py-1">
                                    <div class="text-[9px] font-bold text-slate-500 leading-none">${a.l}${a.tag?`<br><span class=\"gun-tag\">${a.tag}</span>`:''}</div>
                                    <div class="text-xs font-black text-white mt-1">${a.v}</div>
                                </div>
                                <button onclick="event.stopPropagation(); changeAttr(${p.uid},'${a.k}',1)" class="tall-btn">ï¼‹</button>
                            </div>`).join('')}
                    </div>

                    <div class="player-details">
                        <div class="grid grid-cols-3 gap-2 mb-4">${gridHtml}</div>

                        <div class="flex justify-between items-center text-[10px] font-bold text-slate-600">
                            <label class="flex items-center gap-2"><input type="checkbox" ${p.gasStatus ? 'checked' : ''} onchange="updatePlayer(${p.uid}, 'gasStatus', this.checked)"> æ¯’æ°£å€</label>
                            <div class="flex gap-3">
                                <span class="${p.overweight ? 'text-red-500 font-black' : ''}">è² é‡: ${p.weightUsed}/${p.items.dimensionPocket ? 'âˆ' : p.lod}</span>
                                <button onclick="removePlayer(${p.uid})" class="hover:text-red-500">ç§»é™¤ç©å®¶</button>
                            </div>
                        </div>
                    </div>`;
                list.appendChild(card);
            });
        }

        function renderActiveSelect() {
            const sel = document.getElementById('activePlayerSelect');
            if (!sel) return;
            sel.innerHTML = '<option value="">æœªé¸æ“‡</option>';
            players.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.uid;
                opt.textContent = p.name;
                sel.appendChild(opt);
            });
            sel.value = selectedUid ?? '';
        }

        function renderZones() {
            const overlay = document.getElementById('interactionOverlay'); overlay.innerHTML = '';
            const occupants = {}; const bombedRooms = new Set();
            players.forEach(p => {
                if(p.currentRoomId) (occupants[p.currentRoomId] = occupants[p.currentRoomId] || []).push(p.name);
                if(p.items?.rocketLauncher && p.rocketTarget) bombedRooms.add(p.rocketTarget.toUpperCase());
            });

            const mapTip = document.getElementById('mapStatusTip');
            if (isAimingMode) {
                mapTip.textContent = 'âš ï¸ è«‹åœ¨åœ°åœ–ä¸Šé»é¸è½Ÿç‚¸ç›®æ¨™æˆ¿é–“ âš ï¸';
            } else if (isMoveMode) {
                mapTip.textContent = 'âš ï¸ è«‹åœ¨åœ°åœ–ä¸Šé»é¸ç§»å‹•ç›®æ¨™æˆ¿é–“ âš ï¸';
            }
            mapTip.classList.toggle('hidden', !(isAimingMode || isMoveMode));

            mapConfig.forEach(conf => {
                const zone = document.createElement('div');
                const p = selectedUid ? players.find(x => x.uid === selectedUid) : null;
                const isCurrentLoc = p && p.currentRoomId === conf.id;
                const isBombed = bombedRooms.has(conf.id.toUpperCase());
                zone.className = `room-zone ${isCurrentLoc ? 'room-target' : ''} ${isBombed ? 'room-bombed' : ''}`;
                zone.style.cssText = `left:${conf.x}%; top:${conf.y}%; width:${conf.w}%; height:${conf.h}%;`;
                if (occupants[conf.id]) {
                    const wrap = document.createElement('div');
                    wrap.className = 'occupant-stack';
                    occupants[conf.id].forEach(name => {
                        const tag = document.createElement('div');
                        tag.className = 'occupant-tag';
                        tag.innerText = name;
                        wrap.appendChild(tag);
                    });
                    zone.appendChild(wrap);
                }
                zone.onclick = (e) => { e.stopPropagation(); moveOrTarget(conf.id); }; overlay.appendChild(zone);
            });
        }

        function renderSummary() { 
            const tbody = document.getElementById('summaryTableBody'); 
            const data = getCalculatedState(); tbody.innerHTML = ''; 
            data.forEach(p => { 
                const tr = document.createElement('tr'); 
                tr.innerHTML = `<td class="p-3 font-bold text-white">${p.name}</td><td class="p-3 text-slate-500">${p.currentRoomId || '--'}</td><td class="p-3 font-mono text-blue-500">${p.totalStr}/${p.finalSpdText}/${p.items.dimensionPocket ? 'âˆ' : p.lod}</td><td class="p-3 text-right text-amber-500 font-black">${p.newHp}</td>`; 
                tbody.appendChild(tr); 
            }); 
        }

        function updatePlayer(uid, field, val) { const p = players.find(x => x.uid === uid); if(p) { p[field] = val; renderAll(); save(); } }
        function removePlayer(uid) {
            if(confirm('ç¢ºå®šç§»é™¤ç©å®¶ï¼Ÿ')) {
                players = players.filter(x => x.uid !== uid);
                if (selectedUid === uid) selectedUid = players[0]?.uid || null;
                renderAll(); save();
            }
        }
        function resetData() { if(confirm('æŠ¹é™¤æ‰€æœ‰ç·©å­˜æ•¸æ“šï¼Ÿ')) { players = []; localStorage.removeItem(STORAGE_KEY); renderAll(); } }
    </script>
</body>
</html>
