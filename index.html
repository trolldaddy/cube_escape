<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é­”æ–¹æ–°ä¸–ç•Œ - æ•´åˆçµ‚ç«¯ V8</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        :root { --top-peek: 72px; }
        body { font-family: 'Noto+Sans+TC', sans-serif; background-color: #020617; color: #e2e8f0; touch-action: manipulation; overflow-x: hidden; }

        /* åœ°åœ–ç›¸é—œæ¨£å¼ */
        #mapContainer { position: relative; width: fit-content; margin: 0 auto; background-color: #0f172a; border-radius: 1.5rem; border: 2px solid #1e293b; overflow: hidden; }
        #bgMapImage { display: block; max-width: 100%; height: auto; z-index: 5; }
        #interactionOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; }
        .room-zone { position: absolute; cursor: pointer; border: 1px solid transparent; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .room-target { background-color: rgba(59, 130, 246, 0.2) !important; border: 2px solid #3b82f6 !important; }
        .room-bombed { background-color: rgba(239, 68, 68, 0.3) !important; border: 2px solid #ef4444 !important; animation: bomb-pulse 1s infinite; }
        .room-poison { background-color: rgba(34, 197, 94, 0.2) !important; border: 2px solid #22c55e !important; }
        @keyframes bomb-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* HP ç¶²æ ¼ */
        .hp-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 2px; width: 100%; height: 8px; }
        .hp-bar-segment { height: 100%; border-radius: 1px; background-color: #1e293b; }
        .hp-active { background-color: #22c55e; }
        .hp-danger { background-color: #ef4444; }
        .hp-will-lose { background-color: #f59e0b; opacity: 0.3; animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { opacity: 0.2; } 50% { opacity: 0.6; } }

        /* é“å…·æ ¼èˆ‡å…©è¡Œé«˜æŒ‰éˆ• */
        .cell-item {
            display: flex; align-items: center; justify-content: space-between;
            border-radius: 12px; border: 2px solid transparent;
            cursor: pointer; transition: all 0.2s; min-height: 70px; overflow: hidden;
        }
        .cell-on { background-color: #2563eb; color: #fff; border-color: #60a5fa; }
        .cell-off { background-color: #1e293b; color: #64748b; border-color: #0f172a; }

        .tall-btn {
            width: 32px; align-self: stretch; display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.2); font-weight: 900; font-size: 16px; transition: background 0.2s;
        }
        .tall-btn:active { background: rgba(255,255,255,0.2); }

        .item-label-container { flex: 1; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 4px; }
        .cell-label { font-size: 11px; font-weight: 800; line-height: 1.2; }

        /* æ•¸å€¼æ¨™ç±¤èˆ‡ä½ç½®æ¨™ç±¤ */
        .gun-tag { font-size: 9px; background: #ef4444; color: white; padding: 1px 3px; border-radius: 4px; margin-left: 2px; font-weight: 900; }
        .room-badge { background: #0f172a; color: #3b82f6; padding: 2px 8px; border-radius: 6px; font-size: 14px; font-weight: 900; border: 1px solid #1e293b; }
        .occupant-tag { background-color: #ef4444; color: white; font-size: 10px; font-weight: 900; padding: 2px 6px; border-radius: 4px; pointer-events: none; border: 1px solid white; z-index: 50; margin: 1px 0; }

        /* ç½®ä¸­é“å…·æ ¼æ¨£å¼ (å³å´å…­æ ¼) */
        .center-item { justify-content: center; text-align: center; flex-direction: column; padding: 8px; }
        .action-btn { background-color: #facc15; color: #000; font-size: 10px; font-weight: 900; padding: 4px 8px; border-radius: 6px; margin-top: 4px; transition: all 0.2s; }
        .action-btn-used { background-color: #475569; color: #cbd5e1; }
        .player-card-active { ring: 2px solid #3b82f6; background-color: #0f172a !important; border-color: #3b82f6 !important; }

        /* æŠ½å±œæ¨£å¼ */
        .drawer-handle { position: absolute; background: #1e293b; color: #cbd5e1; border: 1px solid #334155; border-radius: 9999px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; z-index: 50; }
        .drawer-panel { backdrop-filter: blur(6px); z-index: 40; }
        #leftHandle { writing-mode: vertical-rl; text-orientation: mixed; letter-spacing: 2px; }

        /* åœ°åœ–å¾®èª¿ä½ç½®ï¼Œé¿å…åº•éƒ¨æŠ½å±œé®æ“‹ */
        .map-stage { transform: translateY(-48px); }
        @media (max-width: 640px) {
            :root { --top-peek: 82px; }
            .map-stage { transform: translateY(-32px); }
        }

        /* ä¸Šæ–¹æŠ½å±œä½ˆå±€ï¼šå›ºå®šæ‘˜è¦åˆ—ã€è¡¨æ ¼æ»¾å‹• */
        #topDrawerContent { display: flex; flex-direction: column; gap: 12px; }
        #summaryTableShell { display: flex; flex-direction: column; max-height: min(45vh, 420px); }
        #summaryScrollArea { flex: 1; overflow-y: auto; }
        .summary-footer-row { display: flex; align-items: center; gap: 8px; flex-wrap: nowrap; overflow-x: auto; white-space: nowrap; }
        #poisonSummary { display: inline-flex; align-items: center; gap: 6px; flex-wrap: nowrap; }
        #roundSummaryText { display: inline-flex; align-items: center; gap: 6px; }
    </style>
</head>
<body class="p-3 lg:p-6 min-h-screen relative overflow-hidden">
    <!-- å·¦å´æŠ½å±œï¼šé€šç”¨æ§åˆ¶ -->
    <div id="leftDrawer" data-state="closed" class="drawer-panel fixed left-4 top-1/2 w-80 max-w-[90vw] bg-slate-900/95 border border-slate-800 rounded-2xl shadow-2xl transition-all duration-300" style="transform: translate(-92%, -50%);">
        <button id="leftHandle" class="drawer-handle -right-10 top-1/2 -translate-y-1/2 px-2 py-3" onclick="toggleDrawer('left')">æ§åˆ¶é¢æ¿</button>
        <div class="p-4 space-y-4">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-black text-white">æ§åˆ¶é¢æ¿</h2>
                <select id="gameRound" onchange="renderAll()" class="bg-slate-900 text-amber-500 font-black text-xs px-3 py-2 rounded-xl border border-slate-800 outline-none">
                    <option value="1">å›åˆ 1 (æ¯’-1)</option><option value="2">å›åˆ 2 (æ¯’-2)</option>
                    <option value="3">å›åˆ 3 (æ¯’-2)</option><option value="4">å›åˆ 4 (æ¯’-3)</option>
                    <option value="5">å›åˆ 5 (æ¯’-3)</option><option value="6">å›åˆ 6 (æ¯’-4)</option>
                </select>
            </div>
            <div class="flex gap-2">
                <input type="text" id="playerNameInput" placeholder="è¼¸å…¥ç©å®¶åç¨±..." class="bg-slate-950 border border-slate-800 rounded-xl px-4 py-3 w-full font-bold outline-none" onkeypress="if(event.key==='Enter') addPlayer()">
                <button onclick="addPlayer()" class="bg-blue-600 w-14 rounded-xl font-black text-white text-xl">ï¼‹</button>
            </div>
            <div class="space-y-2">
                <label class="text-[10px] uppercase tracking-widest text-slate-500 font-black">ç•¶å‰è¡Œå‹•ç©å®¶</label>
                <select id="activePlayerSelect" onchange="setActivePlayer(this.value)" class="w-full bg-slate-900 border border-slate-800 rounded-xl px-3 py-2 font-bold text-sm">
                    <option value="">--</option>
                </select>
            </div>
            <div class="space-y-2">
                <label class="text-[10px] uppercase tracking-widest text-slate-500 font-black">æ§åˆ¶å®¤è§£é™¤æ¯’æ°£æˆ¿é–“</label>
                <div class="flex gap-2">
                    <select id="clearRoomSelect" onchange="updateClearedRoom(this.value)" class="w-full bg-slate-900 border border-slate-800 rounded-xl px-3 py-2 font-bold text-sm">
                        <option value="">-- ç„¡ --</option>
                    </select>
                    <button onclick="applyClearedRoom()" class="px-3 py-2 bg-amber-500 text-black font-black rounded-xl text-xs">è§£é™¤</button>
                </div>
                <div id="clearRoomHelper" class="text-[10px] text-slate-500">é¸æ“‡æˆ¿é–“å¾ŒæŒ‰è§£é™¤</div>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="processTurn()" class="bg-emerald-600 py-3 rounded-xl font-black text-white text-sm uppercase">å›åˆçµç®—</button>
                <button onclick="resetData()" class="bg-slate-800 py-3 rounded-xl text-slate-400 font-bold text-xs">æ¸…ç©ºæ•¸æ“š</button>
            </div>
        </div>
    </div>

    <!-- ä¸Šæ–¹æŠ½å±œï¼šå…¨å“¡çµ±è¨ˆ -->
    <div id="topDrawer" data-state="closed" class="drawer-panel fixed left-1/2 -translate-x-1/2 top-3 w-[96vw] max-w-[1400px] bg-slate-900/95 border border-slate-800 rounded-2xl shadow-2xl transition-all duration-300" style="transform: translate(-50%, calc(-100% + var(--top-peek)));">
        <button id="topHandle" class="drawer-handle left-1/2 -translate-x-1/2 bottom-[-14px] px-4 py-1" onclick="toggleDrawer('top')">ç©å®¶è¡¨</button>
        <div class="p-4" id="topDrawerContent">
            <div class="flex justify-end">
                <div id="mapStatusTip" class="bg-red-600/20 text-red-500 text-[10px] font-black px-3 py-1 rounded-xl text-center uppercase tracking-widest hidden border border-red-600/30">âš ï¸ è«‹åœ¨åœ°åœ–ä¸Šé»é¸æˆ¿é–“ âš ï¸</div>
            </div>
            <div class="flex justify-between items-center text-xs text-slate-400 mb-2">
                <div class="flex items-center gap-2">
                    <span class="font-black text-[10px] tracking-widest uppercase">æª¢è¦–å›åˆ</span>
                    <select id="viewRoundSelect" onchange="changeViewRound(this.value)" class="bg-slate-900 border border-slate-800 rounded-lg px-2 py-1 text-xs font-bold">
                        <option value="current">ç•¶å‰ç‹€æ…‹</option>
                    </select>
                </div>
            </div>
            <div id="summaryTableShell" class="bg-slate-900/60 rounded-2xl border border-slate-800 overflow-hidden">
                <div id="summaryScrollArea">
                    <table class="w-full text-left text-[11px] table-fixed">
                        <thead class="bg-slate-800/50 text-slate-500 font-black uppercase">
                            <tr class="text-[10px]">
                                <th class="p-3">å—è©¦è€…</th><th class="p-3">ä½ç½®</th><th class="p-3">åŠ›/é€Ÿ/è² </th><th class="p-3 text-right">HP</th><th class="p-3 text-right">æ‰‹è¡“</th><th class="p-3 text-right">æš—å½±</th><th class="p-3 text-right">æ¯’æ°£</th><th class="p-3 text-right">é£¢é¤“</th><th class="p-3 text-right">ç«ç®­</th><th class="p-3 text-right">æ¶ˆè€—å“</th><th class="p-3 text-right">æ–°HP</th>
                            </tr>
                        </thead>
                        <tbody id="summaryTableBody" class="divide-y divide-slate-800/50"></tbody>
                    </table>
                </div>
                <div class="p-3 bg-slate-900/80 border-t border-slate-800">
                    <div class="summary-footer-row">
                        <div id="roundSummaryText"></div>
                        <div id="poisonSummary"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨æŠ½å±œï¼šç•¶å‰ç©å®¶è©³ç´° -->
    <div id="bottomDrawer" data-state="closed" class="drawer-panel fixed left-1/2 -translate-x-1/2 bottom-4 w-[96vw] max-w-[1200px] bg-slate-900/95 border border-slate-800 rounded-3xl shadow-2xl transition-all duration-300" style="transform: translate(-50%, 70%);">
        <button id="bottomHandle" class="drawer-handle left-1/2 -translate-x-1/2 -top-10 px-4 py-2" onclick="toggleDrawer('bottom')">ç©å®¶è©³æƒ…</button>
        <div id="activePlayerContent" class="p-5"></div>
    </div>

    <div id="topCollapsedSummary" class="fixed left-1/2 -translate-x-1/2 top-1 z-30 pointer-events-none hidden"></div>

    <!-- ç½®ä¸­åœ°åœ– -->
    <div class="relative flex items-center justify-center min-h-screen z-10 map-stage">
        <div class="bg-slate-900/40 rounded-[2rem] border border-slate-800/50 p-4 flex items-center justify-center min-h-[500px] max-w-[90vw]">
            <div id="mapContainer">
                <img id="bgMapImage" src="https://raw.githubusercontent.com/trolldaddy/cube_escape/b03b1311f1a19acb5841f42579a0e78f2033ce48/p650925325.jpg" alt="åœ°åœ–" onload="renderZones()">
                <div id="interactionOverlay"></div>
            </div>
        </div>
    </div>

    <!-- çµç®—å½ˆçª— -->
    <div id="resultModal" class="fixed inset-0 bg-black/90 z-[100] hidden flex items-center justify-center p-6">
        <div class="bg-slate-900 border border-slate-700 rounded-[2rem] max-w-md w-full p-6 space-y-4">
            <h3 class="text-xl font-black text-white">å›åˆçµç®—å ±å‘Š</h3>
            <div id="resultContent" class="space-y-2 text-sm text-slate-400"></div>
            <div class="flex justify-end gap-2 pt-4">
                <button onclick="document.getElementById('resultModal').classList.add('hidden')" class="px-4 py-2 text-slate-500 font-bold">å–æ¶ˆ</button>
                <button onclick="confirmSettle()" class="px-6 py-2 bg-blue-600 rounded-xl font-black text-white">ç¢ºèªæ›´æ–°</button>
            </div>
        </div>
    </div>

    <script>
        let players = [];
        let selectedUid = null;
        let isAimingMode = false;
        let isMoveMode = false;
        let lockedPoisonFloors = new Set();
        let clearedRooms = new Set();
        let settlementInputs = {};
        let settlementHistory = [];
        let viewRound = 'current';
        const STORAGE_KEY = 'cube_escape_v8_refined';
        const mapConfig = [{"id":"201","name":"åŸºå› åº«","x":27.65,"y":8.31,"w":18.41,"h":10.51},{"id":"202","name":"åœæ©Ÿåª","x":67.44,"y":9.76,"w":23.60,"h":8.56},{"id":"101","name":"æ°´å¡”","x":16.44,"y":18.17,"w":6.03,"h":9.91},{"id":"102","name":"æ¿€å…‰å®¤","x":27.87,"y":18.72,"w":18.20,"h":8.86},{"id":"103","name":"*","x":68.92,"y":18.72,"w":6.88,"h":8.71},{"id":"104","name":"#","x":76.54,"y":18.57,"w":14.39,"h":9.01},{"id":"B101","name":"æ§åˆ¶å®¤","x":9.24,"y":28.18,"w":6.88,"h":9.16},{"id":"B102","name":"#","x":16.54,"y":28.48,"w":5.61,"h":9.01},{"id":"B103","name":"*","x":22.89,"y":28.33,"w":4.44,"h":9.16},{"id":"B104","name":"#","x":27.87,"y":28.48,"w":18.10,"h":9.01},{"id":"B105","name":"å›æ”¶ç«™","x":46.70,"y":28.63,"w":10.58,"h":8.71},{"id":"B106","name":"#","x":72.52,"y":28.63,"w":7.20,"h":9.01},{"id":"B107","name":"æ­¦å™¨åº«","x":80.14,"y":28.43,"w":10.58,"h":9.01},{"id":"B201","name":"#","x":9.14,"y":38.34,"w":10.58,"h":9.01},{"id":"B202","name":"æ‰‹è¡“å®¤","x":20.35,"y":38.49,"w":7.09,"h":8.56},{"id":"B203","name":"#","x":27.87,"y":38.24,"w":10.69,"h":8.86},{"id":"B204","name":"é¤å»³","x":38.87,"y":38.24,"w":7.20,"h":9.16},{"id":"B205","name":"#","x":46.70,"y":38.24,"w":6.67,"h":9.16},{"id":"B206","name":"é‡‘åº«","x":68.92,"y":38.19,"w":21.80,"h":9.31},{"id":"B301","name":"è—¥æˆ¿","x":9.14,"y":48.10,"w":6.77,"h":8.71},{"id":"B302","name":"#","x":16.65,"y":47.95,"w":6.88,"h":9.16},{"id":"B303","name":"*","x":24.06,"y":48.10,"w":6.88,"h":9.01},{"id":"B304","name":"æ“ä½œå®¤","x":31.46,"y":48.10,"w":7.20,"h":8.86},{"id":"B305","name":"#","x":39.08,"y":47.95,"w":14.39,"h":9.01},{"id":"B306","name":"#","x":68.92,"y":47.95,"w":4.44,"h":9.01},{"id":"B307","name":"*","x":73.90,"y":47.80,"w":9.63,"h":9.61},{"id":"B308","name":"#","x":83.84,"y":47.95,"w":7.20,"h":9.16},{"id":"B401","name":"#","x":31.57,"y":57.86,"w":14.39,"h":9.01},{"id":"B402","name":"*","x":46.60,"y":57.71,"w":6.67,"h":9.31},{"id":"B403","name":"å‚³é€å®¤","x":68.92,"y":57.71,"w":6.88,"h":9.16},{"id":"B404","name":"#","x":76.44,"y":57.86,"w":6.88,"h":8.71},{"id":"B405","name":"#","x":83.74,"y":57.86,"w":6.98,"h":9.01},{"id":"B501","name":"å¤§å€‰åº«","x":9.14,"y":57.86,"w":21.69,"h":18.62},{"id":"B502","name":"#","x":31.57,"y":67.62,"w":10.58,"h":8.86},{"id":"B503","name":"åƒåœ¾å ´","x":42.79,"y":67.77,"w":14.39,"h":9.01},{"id":"B504","name":"#","x":68.92,"y":67.77,"w":10.58,"h":9.01},{"id":"B505","name":"ç³§å€‰","x":80.14,"y":67.62,"w":10.79,"h":9.16},{"id":"B601","name":"é…’çª–","x":27.87,"y":77.23,"w":17.99,"h":9.31},{"id":"B602","name":"#","x":46.49,"y":77.38,"w":10.69,"h":9.01},{"id":"B603","name":"*","x":57.71,"y":77.38,"w":10.58,"h":9.01},{"id":"B604","name":"#","x":68.92,"y":77.38,"w":10.69,"h":9.01},{"id":"B701","name":"åœå±é–“","x":46.81,"y":87.29,"w":10.26,"h":9.01}];

        window.onload = () => {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    if (Array.isArray(parsed)) {
                        players = parsed;
                    } else {
                        players = parsed.players || [];
                        const legacyClear = parsed.clearedRoomId || '';
                        clearedRooms = new Set(parsed.clearedRooms || (legacyClear ? [legacyClear] : []));
                        lockedPoisonFloors = new Set(parsed.lockedPoisonFloors || parsed.poisonFloors || []);
                        settlementInputs = parsed.settlementInputs || {};
                        settlementHistory = parsed.settlementHistory || [];
                        viewRound = parsed.viewRound || 'current';
                    }
                } catch (e) {
                    players = [];
                }
            }
            if (players.length > 0) selectedUid = players[0].uid;
            renderAll();
        };
        function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify({ players, clearedRooms: Array.from(clearedRooms), lockedPoisonFloors: Array.from(lockedPoisonFloors), settlementInputs, settlementHistory, viewRound })); }

        function toggleDrawer(which, targetState) {
            const el = which === 'top' ? document.getElementById('topDrawer') : which === 'left' ? document.getElementById('leftDrawer') : document.getElementById('bottomDrawer');
            const transforms = {
                top: { open: 'translate(-50%, 0)', closed: 'translate(-50%, calc(-100% + var(--top-peek)))' },
                left: { open: 'translate(0, -50%)', closed: 'translate(-92%, -50%)' },
                bottom: { open: 'translate(-50%, 0)', closed: 'translate(-50%, 70%)' }
            };
            const desired = targetState || (el.dataset.state === 'open' ? 'closed' : 'open');
            el.style.transform = transforms[which][desired];
            el.dataset.state = desired;
            renderPoisonState();
        }

        function ensureSettlementInputs() {
            players.forEach(p => {
                if (!settlementInputs[p.uid]) {
                    settlementInputs[p.uid] = { hunger: 0, consumable: 'none' };
                }
            });
        }

        function changeViewRound(val) {
            viewRound = val || 'current';
            renderAll();
            save();
        }

        function getRoomFloor(roomId) {
            if (!roomId) return '';
            const upper = roomId.toUpperCase();
            if (upper.startsWith('B')) return upper.slice(0, 2);
            return `${upper[0]}F`;
        }

        function getWinningPoisonFloors() {
            const counts = {};
            players.forEach(p => {
                const floor = (p.poisonFloor || '').toUpperCase();
                if (!floor || lockedPoisonFloors.has(floor)) return;
                const weight = p.tenVote ? 10 : 1;
                counts[floor] = (counts[floor] || 0) + weight;
            });
            const entries = Object.entries(counts);
            if (entries.length === 0) return new Set();
            const maxVote = Math.max(...entries.map(([, c]) => c));
            if (maxVote <= 0) return new Set();
            return new Set(entries.filter(([, c]) => c === maxVote).map(([f]) => f));
        }

        function getActivePoisonFloors() {
            return new Set(lockedPoisonFloors);
        }

        function buildRocketHitMap() {
            const map = {};
            players.forEach(shooter => {
                if (shooter.items?.rocketLauncher && shooter.rocketTarget) {
                    const key = shooter.rocketTarget.toUpperCase();
                    map[key] = (map[key] || 0) + 4;
                }
            });
            return map;
        }

        function getConsumableDelta(code) {
            if (code === 'pill') return 2;
            return 0;
        }

        function buildSettlementRows(sourcePlayers = players) {
            ensureSettlementInputs();
            const round = parseInt(document.getElementById('gameRound').value);
            const gasDmgList = [0, 1, 2, 2, 3, 3, 4];
            const gasDmg = gasDmgList[round];
            const activePoisonFloors = getActivePoisonFloors();
            const rocketMap = buildRocketHitMap();

            return sourcePlayers.map(p => {
                const upperRoom = p.currentRoomId?.toUpperCase() || '';
                const maskOn = p.items?.mask;
                const shadow = p.isShadow;
                const gasOn = upperRoom ? isRoomPoisoned(upperRoom, activePoisonFloors) : false;
                const poisonDelta = (!maskOn && gasOn && !shadow) ? -gasDmg : 0;
                const rocketDelta = upperRoom ? -(rocketMap[upperRoom] || 0) : 0;
                const surgeryDelta = upperRoom === 'B202' ? 2 : 0;
                const shadowDelta = 0;
                const hunger = settlementInputs[p.uid]?.hunger ?? 0;
                const consumable = settlementInputs[p.uid]?.consumable || 'none';
                const consumableDelta = getConsumableDelta(consumable);

                const weightUsed = ((p.items?.mask?1:0) + (p.items?.rope?1:0) + (p.items?.adrenaline?1:0) + (p.items?.recycler?1:0) + (p.items?.rocketLauncher?1:0)) + ((p.weapons?.shotgun||0) + (p.weapons?.pistol||0) + (p.weapons?.knife||0));
                const weaponStrBonus = (p.weapons?.shotgun * 4 || 0) + (p.weapons?.pistol * 2 || 0) + (p.weapons?.knife * 2 || 0);
                const totalStr = p.str + weaponStrBonus;
                const finalSpdText = p.items?.adrenaline ? `${p.spd} (10)` : p.spd;

                const newHp = Math.max(0, p.hp + surgeryDelta + shadowDelta + poisonDelta + hunger + rocketDelta + consumableDelta);

                return {
                    ...p,
                    gasStatus: gasOn,
                    totalStr,
                    finalSpdText,
                    weightUsed,
                    overweight: !p.items?.dimensionPocket && weightUsed > p.lod,
                    baseHp: p.hp,
                    surgeryDelta,
                    shadowDelta,
                    poisonDelta,
                    hungerDelta: hunger,
                    rocketDelta,
                    consumable,
                    consumableDelta,
                    newHp,
                };
            });
        }

        function isRoomPoisoned(roomId, activeFloors) {
            if (!roomId) return false;
            const upper = roomId.toUpperCase();
            if (clearedRooms.has(upper)) return false;
            if (upper === '202') return false;
            if (upper === 'B501') return activeFloors.has('B4') && activeFloors.has('B5');
            const floor = getRoomFloor(upper);
            return activeFloors.has(floor);
        }

        function getCalculatedState() {
            const round = parseInt(document.getElementById('gameRound').value);
            const gasDmgList = [0, 1, 2, 2, 3, 3, 4];
            const gasDmg = gasDmgList[round];
            const activePoisonFloors = getActivePoisonFloors();

            return players.map(p => {
                let dmg = 0; let weightUsed = 0;
                let weaponStrBonus = (p.weapons.shotgun * 4) + (p.weapons.pistol * 2) + (p.weapons.knife * 2);

                weightUsed += (p.items.mask?1:0) + (p.items.rope?1:0) + (p.items.adrenaline?1:0) + (p.items.recycler?1:0) + (p.items.rocketLauncher?1:0);
                weightUsed += (p.weapons.shotgun || 0) + (p.weapons.pistol || 0) + (p.weapons.knife || 0);

                let gasStatus = false;
                if (p.currentRoomId) {
                    gasStatus = isRoomPoisoned(p.currentRoomId, activePoisonFloors);
                }

                if (!p.items.mask && gasStatus && !p.isShadow) dmg += gasDmg;
                players.forEach(other => { if (other.items.rocketLauncher && other.rocketTarget && p.currentRoomId?.toUpperCase() === other.rocketTarget.toUpperCase()) dmg += 4; });

                const finalSpdText = p.items.adrenaline ? `${p.spd} (10)` : p.spd;
                const totalStr = p.str + weaponStrBonus;
                const hasGun = (p.weapons.shotgun > 0) || (p.weapons.pistol > 0);

                return { ...p, gasStatus, totalStr, expectedDmg: dmg, newHp: Math.max(0, p.hp - dmg), finalSpdText, weightUsed, overweight: !p.items.dimensionPocket && weightUsed > p.lod, hasGun };
            });
        }

        function addPlayer() {
            const name = document.getElementById('playerNameInput').value.trim();
            if (!name) return;
            players.push({ uid: Date.now(), name, hp: 10, currentRoomId: null, gasStatus: false, poisonFloor: '', tenVote: false, isShadow: false, str: 4, spd: 3, lod: 3, rocketTarget: '', recyclerUsed: false, weapons: { shotgun: 0, pistol: 0, knife: 0 }, items: { mask: false, rope: false, adrenaline: false, recycler: false, rocketLauncher: false, dimensionPocket: false } });
            document.getElementById('playerNameInput').value = '';
            settlementInputs[players[players.length - 1].uid] = { hunger: 0, consumable: 'none' };
            selectedUid = players[players.length - 1].uid;
            renderAll();
            save();
        }

        function setActivePlayer(uidStr) {
            const uid = parseInt(uidStr);
            if (!uid) return;
            selectedUid = uid;
            isAimingMode = false;
            isMoveMode = false;
            renderAll();
        }

        function toggleItem(uid, key) {
            const p = players.find(x => x.uid === uid);
            if (p) { p.items[key] = !p.items[key]; if (key === 'rocketLauncher' && !p.items[key]) { p.rocketTarget = ''; } renderAll(); save(); }
        }

        function toggleRecyclerUse(uid) {
            const p = players.find(x => x.uid === uid);
            if (p) { p.recyclerUsed = !p.recyclerUsed; renderAll(); save(); }
        }

        function changeWeapon(uid, key, delta) {
            const p = players.find(x => x.uid === uid);
            if (p) { p.weapons[key] = Math.max(0, p.weapons[key] + delta); renderAll(); save(); }
        }

        function changeAttr(uid, key, delta) { const p = players.find(x => x.uid === uid); if (p) { p[key] = Math.max(0, p[key] + delta); renderAll(); save(); } }
        function selectPlayer(uid) { selectedUid = uid; isAimingMode = false; isMoveMode = false; renderAll(); }

        function enableMoveMode() {
            isMoveMode = true;
            isAimingMode = false;
            document.getElementById('mapStatusTip').classList.remove('hidden');
            document.getElementById('mapStatusTip').innerText = 'âš ï¸ é»æ“Šåœ°åœ–é¸æ“‡ç§»å‹•ä½ç½® âš ï¸';
        }

        function enableAimMode() {
            isAimingMode = true;
            isMoveMode = false;
            document.getElementById('mapStatusTip').classList.remove('hidden');
            document.getElementById('mapStatusTip').innerText = 'âš ï¸ é»æ“Šåœ°åœ–ç„æº–ç«ç®­ç›®æ¨™ âš ï¸';
        }

        function moveOrTarget(rid) {
            if (!selectedUid) return;
            const p = players.find(x => x.uid === selectedUid);
            if (isAimingMode) {
                p.rocketTarget = rid;
                isAimingMode = false;
            } else if (isMoveMode) {
                p.currentRoomId = rid;
                isMoveMode = false;
            } else {
                return;
            }
            document.getElementById('mapStatusTip').classList.add('hidden');
            renderAll(); save();
        }

        function renderSettlementModal() {
            const rows = buildSettlementRows();
            const hungerOptions = [-0, -1, -2];
            const resultContent = document.getElementById('resultContent');
            const winners = getWinningPoisonFloors();
            const newFloors = Array.from(winners).filter(f => !lockedPoisonFloors.has(f));

            const headerNote = winners.size > 0 ? `<div class="text-emerald-300 font-black">æœ€é«˜ç¥¨æ¨“å±¤ï¼š${Array.from(winners).join(', ')}${newFloors.length ? 'ï¼ˆæœ¬å›åˆæ–°å¢ï¼‰' : ''}</div>` : '';

            const tableBody = rows.map(r => `
                <tr class="divide-x divide-slate-800">
                    <td class="p-2">${r.name}</td>
                    <td class="p-2 text-slate-400">${r.currentRoomId || '--'}</td>
                    <td class="p-2 font-mono text-blue-400">${r.totalStr}/${r.finalSpdText}/${r.items.dimensionPocket ? 'âˆ' : r.lod}</td>
                    <td class="p-2 text-right">${r.baseHp}</td>
                    <td class="p-2 text-right">${r.surgeryDelta >= 0 ? '+' : ''}${r.surgeryDelta}</td>
                    <td class="p-2 text-right">${r.shadowDelta >= 0 ? '+' : ''}${r.shadowDelta}</td>
                    <td class="p-2 text-right">${r.poisonDelta}</td>
                    <td class="p-2 text-right">
                        <select class="bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs" onchange="updateHunger(${r.uid}, this.value)">
                            ${hungerOptions.map(h => `<option value="${h}" ${r.hungerDelta === h ? 'selected' : ''}>${h}</option>`).join('')}
                        </select>
                    </td>
                    <td class="p-2 text-right">${r.rocketDelta}</td>
                    <td class="p-2 text-right">
                        <select class="bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs" onchange="updateConsumable(${r.uid}, this.value)">
                            <option value="none" ${r.consumable === 'none' ? 'selected' : ''}>æœªä½¿ç”¨</option>
                            <option value="pill" ${r.consumable === 'pill' ? 'selected' : ''}>è—¥ç‰‡(+2)</option>
                            <option value="adrenaline" ${r.consumable === 'adrenaline' ? 'selected' : ''}>è…ä¸Šè…ºç´ (+0)</option>
                        </select>
                    </td>
                    <td class="p-2 text-right font-black text-amber-400">${r.newHp}</td>
                </tr>
            `).join('');

            resultContent.innerHTML = `
                ${headerNote}
                <div class="mt-2 overflow-x-auto">
                    <table class="w-full text-[11px] text-left">
                        <thead class="bg-slate-800/60 text-slate-400 font-black uppercase">
                            <tr class="divide-x divide-slate-700">
                                <th class="p-2">å—è©¦è€…</th><th class="p-2">ä½ç½®</th><th class="p-2">åŠ›/é€Ÿ/è² </th><th class="p-2 text-right">HP</th><th class="p-2 text-right">æ‰‹è¡“</th><th class="p-2 text-right">æš—å½±</th><th class="p-2 text-right">æ¯’æ°£</th><th class="p-2 text-right">é£¢é¤“</th><th class="p-2 text-right">ç«ç®­</th><th class="p-2 text-right">æ¶ˆè€—å“</th><th class="p-2 text-right">æ–°HP</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-800">${tableBody}</tbody>
                    </table>
                </div>`;
        }

        function processTurn() {
            ensureSettlementInputs();
            renderSettlementModal();
            document.getElementById('resultModal').classList.remove('hidden');
        }

        function confirmSettle() {
            const rows = buildSettlementRows();
            const winners = getWinningPoisonFloors();
            lockedPoisonFloors = new Set([...lockedPoisonFloors, ...winners]);

            settlementHistory = settlementHistory.filter(entry => entry.round !== parseInt(document.getElementById('gameRound').value));
            settlementHistory.push({ round: parseInt(document.getElementById('gameRound').value), rows: rows.map(r => ({...r})) });

            players = rows.map(p => ({ ...p, hp: p.newHp, rocketTarget: '', recyclerUsed: false, items: { ...p.items, adrenaline: false }}));
            document.getElementById('resultModal').classList.add('hidden');

            const roundSel = document.getElementById('gameRound');
            if (roundSel && roundSel.selectedIndex < roundSel.options.length - 1) {
                roundSel.selectedIndex += 1;
            }
            viewRound = 'current';
            settlementInputs = {};
            renderAll();
            save();
        }

        function renderAll() { renderSummary(); renderZones(); renderActivePlayer(); renderSelectOptions(); renderRoundViewer(); renderPoisonState(); }

        function renderRoundViewer() {
            const select = document.getElementById('viewRoundSelect');
            if (!select) return;
            const currentVal = select.value || viewRound;
            select.innerHTML = '<option value="current">ç•¶å‰ç‹€æ…‹</option>';
            settlementHistory.sort((a,b) => a.round - b.round).forEach(entry => {
                const opt = document.createElement('option');
                opt.value = `${entry.round}`;
                opt.textContent = `å›åˆ ${entry.round}`;
                if (opt.value === currentVal) opt.selected = true;
                select.appendChild(opt);
            });
        }

        function renderSelectOptions() {
            const select = document.getElementById('activePlayerSelect');
            const current = select.value;
            select.innerHTML = '<option value="">--</option>';
            players.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.uid;
                opt.textContent = p.name;
                if (p.uid == selectedUid || p.uid == current) opt.selected = true;
                select.appendChild(opt);
            });

            const clearSelect = document.getElementById('clearRoomSelect');
            const existing = clearSelect.value;
            clearSelect.innerHTML = '<option value="">-- ç„¡ --</option>';
            const activeFloors = getActivePoisonFloors();
            mapConfig.forEach(r => {
                if (!isRoomPoisoned(r.id, activeFloors)) return;
                const opt = document.createElement('option');
                opt.value = r.id;
                opt.textContent = `${r.id} ${r.name}`;
                if (r.id === existing) opt.selected = true;
                clearSelect.appendChild(opt);
            });
        }

        function updateClearedRoom(val) {
            const target = val || '';
            const indicator = document.getElementById('clearRoomHelper');
            if (indicator) indicator.textContent = target ? `æº–å‚™è§£é™¤ï¼š${target}` : 'é¸æ“‡æˆ¿é–“å¾ŒæŒ‰è§£é™¤';
        }

        function updateHunger(uid, val) {
            ensureSettlementInputs();
            settlementInputs[uid] = settlementInputs[uid] || { hunger: 0, consumable: 'none' };
            settlementInputs[uid].hunger = parseInt(val, 10);
            renderSettlementModal();
            save();
        }

        function updateConsumable(uid, val) {
            ensureSettlementInputs();
            settlementInputs[uid] = settlementInputs[uid] || { hunger: 0, consumable: 'none' };
            settlementInputs[uid].consumable = val;
            renderSettlementModal();
            save();
        }

        function applyClearedRoom() {
            const sel = document.getElementById('clearRoomSelect');
            if (!sel.value) return;
            clearedRooms.add(sel.value.toUpperCase());
            renderAll();
            save();
        }

        function renderPoisonState() {
            const summary = document.getElementById('poisonSummary');
            const roundSummary = document.getElementById('roundSummaryText');
            const collapsed = document.getElementById('topCollapsedSummary');
            const topDrawer = document.getElementById('topDrawer');
            const locked = new Set(lockedPoisonFloors);
            const winners = getWinningPoisonFloors();
            const pending = Array.from(winners).filter(f => !locked.has(f));
            const chipDefs = [];

            const roundSel = document.getElementById('gameRound');
            const roundText = roundSel?.options[roundSel.selectedIndex]?.textContent || '';

            if (locked.size === 0) {
                chipDefs.push({ label: 'ç›®å‰ç„¡æ¯’æ°£æ¨“å±¤', className: 'bg-slate-800 text-slate-400 border border-slate-700' });
            } else {
                Array.from(locked).sort().forEach(floor => {
                    chipDefs.push({ label: `${floor}ï¼ˆå·²é–å®šï¼‰`, className: 'bg-emerald-500/20 text-emerald-200 border border-emerald-500/40' });
                });
            }

            if (pending.length > 0) {
                chipDefs.push({ label: 'å¾…çµç®—', className: 'bg-blue-500/20 text-blue-100 border border-blue-500/40' });
                pending.sort().forEach(floor => {
                    chipDefs.push({ label: `${floor}ï¼ˆæœ€é«˜ç¥¨ï¼‰`, className: 'bg-blue-500/20 text-blue-100 border border-blue-500/40' });
                });
            }

            if (clearedRooms.size > 0) {
                chipDefs.push({ label: 'å·²è§£é™¤', className: 'bg-amber-500/20 text-amber-200 border border-amber-500/40' });
                Array.from(clearedRooms).sort().forEach(room => {
                    chipDefs.push({ label: room, className: 'bg-amber-500/20 text-amber-200 border border-amber-500/40' });
                });
            }

            const makeChipHtml = (label, color) => `<span class="px-2 py-1 rounded-lg text-[10px] font-black ${color}">${label}</span>`;
            const chipsHtml = chipDefs.map(def => makeChipHtml(def.label, def.className)).join('');

            if (roundSummary) {
                roundSummary.innerHTML = `<span class="text-[10px] text-slate-400 font-black uppercase tracking-widest">å›åˆæ‘˜è¦</span>` +
                    `<span class="text-[11px] text-amber-300 font-bold">${roundText}</span>`;
            }

            if (summary) {
                summary.innerHTML = `<span class="text-[10px] text-slate-400 font-black uppercase tracking-widest">æ¯’æ°£ç‹€æ…‹</span>${chipsHtml}`;
            }

            if (collapsed) {
                const isClosed = (topDrawer?.dataset.state || 'open') === 'closed';
                collapsed.classList.toggle('hidden', !isClosed);
                if (isClosed) {
                    collapsed.innerHTML = `<div class="bg-slate-900/80 border border-slate-800 rounded-xl px-4 py-2 shadow-xl inline-flex items-center gap-2 pointer-events-auto whitespace-nowrap overflow-x-auto">` +
                        `<span class="text-xs font-black text-white">å›åˆæ‘˜è¦</span>` +
                        `<span class="text-[11px] text-amber-300 font-bold">${roundText}</span>` +
                        chipsHtml +
                        `</div>`;
                } else {
                    collapsed.innerHTML = '';
                }
            }
        }

        function renderActivePlayer() {
            const container = document.getElementById('activePlayerContent');
            container.innerHTML = '';
            const data = getCalculatedState();
            const p = data.find(x => x.uid === selectedUid);
            if (!p) { container.innerHTML = '<div class="text-center text-slate-500">å°šæœªé¸æ“‡ç©å®¶</div>'; return; }

            let hpHtml = ''; for(let i=1; i<=10; i++) { hpHtml += `<div class="hp-bar-segment ${i <= p.newHp ? (p.newHp <= 3 ? 'hp-danger' : 'hp-active') : (i <= p.hp ? 'hp-will-lose' : '')}"></div>`; }

            const gridHtml = [
                { type: 'weapon', k: 'shotgun', l: 'éœ°å½ˆæ§', e: 'ğŸ”«' },
                { type: 'item', k: 'adrenaline', l: 'è…ä¸Šè…ºç´ ', e: 'ğŸ’‰' },
                { type: 'item', k: 'rocketLauncher', l: 'ç«ç®­ç­’', e: 'ğŸš€', action: 'aim' },
                { type: 'weapon', k: 'pistol', l: 'æ‰‹æ§', e: 'ğŸ”«' },
                { type: 'item', k: 'rope', l: 'ç¹©ç´¢', e: 'ğŸª¢' },
                { type: 'item', k: 'dimensionPocket', l: 'æ¬¡å…ƒå£è¢‹', e: 'ğŸŒ€' },
                { type: 'weapon', k: 'knife', l: 'å°åˆ€', e: 'ğŸ”ª' },
                { type: 'item', k: 'mask', l: 'é˜²æ¯’é¢å…·', e: 'ğŸ­' },
                { type: 'item', k: 'recycler', l: 'å¾ªç’°å›æ”¶', e: 'â™»ï¸', action: 'use' }
            ].map((item) => {
                if (item.type === 'weapon') {
                    const count = p.weapons[item.k];
                    return `<div class="cell-item ${count > 0 ? 'cell-on' : 'cell-off'}">
                        <button onclick="changeWeapon(${p.uid}, '${item.k}', -1)" class="tall-btn">ï¼</button>
                        <div class="item-label-container">
                            <span class="cell-label">${item.e}<br>${item.l}</span>
                            <span class="text-xs font-black mt-1">${count}</span>
                        </div>
                        <button onclick="changeWeapon(${p.uid}, '${item.k}', 1)" class="tall-btn">ï¼‹</button>
                    </div>`;
                } else {
                    const on = p.items[item.k];
                    let actionHtml = '';
                    if (on && item.action === 'aim') {
                        actionHtml = `<button onclick="enableAimMode()" class="action-btn">${p.rocketTarget || 'ç„æº–'}</button>`;
                    } else if (on && item.action === 'use') {
                        actionHtml = `<button onclick="toggleRecyclerUse(${p.uid})" class="action-btn ${p.recyclerUsed ? 'action-btn-used' : ''}">${p.recyclerUsed ? 'å·²ä½¿ç”¨' : 'ä½¿ç”¨'}</button>`;
                    }
                    return `<div onclick="toggleItem(${p.uid}, '${item.k}')" class="cell-item center-item ${on ? 'cell-on' : 'cell-off'}">
                        <span class="cell-label">${item.e} ${item.l}</span>
                        <div class="text-[9px] opacity-60">${on ? 'å·²æŒæœ‰' : 'æœªæŒæœ‰'}</div>
                        ${actionHtml}
                    </div>`;
                }
            }).join('');

            const poisonFloorOptions = ['', '2F', '1F', 'B1', 'B2', 'B3', 'B4', 'B5', 'B6', 'B7'];
            const availableFloors = poisonFloorOptions.filter(f => !lockedPoisonFloors.has(f) || f === p.poisonFloor);
            const poisonSelect = `
                <select class="bg-slate-900 border border-slate-700 rounded-lg px-2 py-1 text-xs font-black"
                    onchange="updatePlayer(${p.uid}, 'poisonFloor', this.value)">
                    ${availableFloors.map(v => `<option value="${v}" ${(p.poisonFloor === v || (!p.poisonFloor && v === '')) ? 'selected' : ''} ${lockedPoisonFloors.has(v) && v === p.poisonFloor ? 'disabled' : ''}>${v ? (lockedPoisonFloors.has(v) ? v + 'ï¼ˆå·²æ¯’ï¼‰' : v) : 'æœªé¸æ“‡'}</option>`).join('')}
                </select>`;

            container.innerHTML = `
                <div class="flex flex-wrap justify-between items-center gap-3 mb-3">
                    <div class="flex items-center gap-3 flex-wrap">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl font-black text-white">${p.name}</span>
                            <span class="room-badge">${p.currentRoomId || '??'}</span>
                            <button class="px-3 py-2 text-xs font-black bg-blue-600 rounded-xl" onclick="enableMoveMode()">ç§»å‹•</button>
                        </div>
                        <div class="flex items-center gap-3 text-xs font-black text-slate-300">
                            <label class="flex items-center gap-1">æŠ•æ¯’æ¨“å±¤ ${poisonSelect}</label>
                            <label class="flex items-center gap-1"><input type="checkbox" ${p.tenVote ? 'checked' : ''} onchange="updatePlayer(${p.uid}, 'tenVote', this.checked)">10ç¥¨</label>
                        </div>
                        <div class="w-full text-xs text-slate-500">è² é‡: <span class="${p.overweight ? 'text-red-500 font-black' : ''}">${p.weightUsed}/${p.items.dimensionPocket ? 'âˆ' : p.lod}</span></div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-2xl font-black ${p.hp <= 3 ? 'text-red-500' : 'text-green-500'}">${p.hp}</span>
                        <button class="text-[10px] px-2 py-1 rounded-lg bg-slate-800 border border-slate-700" onclick="toggleDrawer('bottom')">æ”¶åˆ</button>
                    </div>
                </div>
                <div class="hp-grid mb-4">${hpHtml}</div>

                <div class="grid grid-cols-3 gap-2 mb-4">
                    ${[{k:'str',l:'æ­¦åŠ›',v:p.totalStr,tag:p.hasGun?'(æŒæ§)':''},{k:'spd',l:'é€Ÿåº¦',v:p.finalSpdText},{k:'lod',l:'è² é‡',v:p.lod}].map(a => `
                        <div class="bg-slate-950/40 rounded-xl overflow-hidden flex justify-between items-center border border-slate-800">
                            <button onclick="changeAttr(${p.uid},'${a.k}',-1)" class="tall-btn">ï¼</button>
                            <div class="text-center py-1">
                                <div class="text-[9px] font-bold text-slate-500 leading-none">${a.l}${a.tag?`<br><span class='gun-tag'>${a.tag}</span>`:''}</div>
                                <div class="text-xs font-black text-white mt-1">${a.v}</div>
                            </div>
                            <button onclick="changeAttr(${p.uid},'${a.k}',1)" class="tall-btn">ï¼‹</button>
                        </div>`).join('')}
                </div>

                <div class="grid grid-cols-3 gap-2 mb-4">${gridHtml}</div>

                <div class="flex justify-end items-center text-[10px] font-bold text-slate-600">
                    <button onclick="removePlayer(${p.uid})" class="hover:text-red-500">ç§»é™¤ç©å®¶</button>
                </div>`;
        }

        function renderSummary() {
            const tbody = document.getElementById('summaryTableBody');
            let data;
            if (viewRound !== 'current') {
                const found = settlementHistory.find(e => `${e.round}` === `${viewRound}`);
                data = found ? found.rows : buildSettlementRows();
            } else {
                data = buildSettlementRows();
            }
            tbody.innerHTML = '';
            data.forEach(p => {
                const consumableLabel = p.consumable === 'pill' ? 'è—¥ç‰‡' : p.consumable === 'adrenaline' ? 'è…ä¸Šè…ºç´ ' : '--';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-3 font-bold text-white">${p.name}</td>
                    <td class="p-3 text-slate-500">${p.currentRoomId || '--'}</td>
                    <td class="p-3 font-mono text-blue-500">${p.totalStr}/${p.finalSpdText}/${p.items.dimensionPocket ? 'âˆ' : p.lod}</td>
                    <td class="p-3 text-right text-white">${p.baseHp}</td>
                    <td class="p-3 text-right ${p.surgeryDelta>0?'text-emerald-400':'text-slate-300'}">${p.surgeryDelta>=0?'+':''}${p.surgeryDelta}</td>
                    <td class="p-3 text-right text-slate-300">${p.shadowDelta>=0?'+':''}${p.shadowDelta}</td>
                    <td class="p-3 text-right text-red-400">${p.poisonDelta}</td>
                    <td class="p-3 text-right text-amber-400">${p.hungerDelta}</td>
                    <td class="p-3 text-right text-red-400">${p.rocketDelta}</td>
                    <td class="p-3 text-right text-emerald-300">${consumableLabel} ${p.consumableDelta?`(${p.consumableDelta>=0?'+':''}${p.consumableDelta})`:''}</td>
                    <td class="p-3 text-right text-amber-500 font-black">${p.newHp}</td>`;
                if (viewRound === 'current') tr.onclick = () => selectPlayer(p.uid);
                tbody.appendChild(tr);
            });
        }

        function renderZones() {
            const overlay = document.getElementById('interactionOverlay'); overlay.innerHTML = '';
            const occupants = {};
            const bombedRooms = new Set();
            const activePoisonFloors = getActivePoisonFloors();
            players.forEach(p => {
                if(p.currentRoomId) (occupants[p.currentRoomId] = occupants[p.currentRoomId] || []).push(p.name);
                if(p.items?.rocketLauncher && p.rocketTarget) bombedRooms.add(p.rocketTarget.toUpperCase());
            });
            document.getElementById('mapStatusTip').classList.toggle('hidden', !(isAimingMode || isMoveMode));
            mapConfig.forEach(conf => {
                const zone = document.createElement('div');
                const p = selectedUid ? players.find(x => x.uid === selectedUid) : null;
                const isCurrentLoc = p && p.currentRoomId === conf.id;
                const isBombed = bombedRooms.has(conf.id.toUpperCase());
                const poisoned = isRoomPoisoned(conf.id, activePoisonFloors);
                zone.className = `room-zone ${isCurrentLoc ? 'room-target' : ''} ${isBombed ? 'room-bombed' : ''} ${poisoned ? 'room-poison' : ''}`;
                zone.style.cssText = `left:${conf.x}%; top:${conf.y}%; width:${conf.w}%; height:${conf.h}%;`;
                if (occupants[conf.id]) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'flex flex-col items-center pointer-events-none';
                    occupants[conf.id].forEach(name => {
                        const tag = document.createElement('div');
                        tag.className = 'occupant-tag';
                        tag.innerText = name;
                        wrapper.appendChild(tag);
                    });
                    zone.appendChild(wrapper);
                }
                zone.onclick = (e) => { e.stopPropagation(); moveOrTarget(conf.id); }; overlay.appendChild(zone);
            });
        }

        function updatePlayer(uid, field, val) { const p = players.find(x => x.uid === uid); if(p) { p[field] = val; renderAll(); save(); } }
        function removePlayer(uid) { if(confirm('ç¢ºå®šç§»é™¤ç©å®¶ï¼Ÿ')) { players = players.filter(x => x.uid !== uid); delete settlementInputs[uid]; if (selectedUid === uid) selectedUid = players[0]?.uid || null; renderAll(); save(); } }
        function resetData() { if(confirm('æŠ¹é™¤æ‰€æœ‰ç·©å­˜æ•¸æ“šï¼Ÿ')) { players = []; clearedRooms = new Set(); lockedPoisonFloors = new Set(); localStorage.removeItem(STORAGE_KEY); selectedUid = null; renderAll(); } }
    </script>
</body>
</html>
